---
title: "Predicting fast growth"
output: 
  flexdashboard::flex_dashboard:
    theme: journal #  yeti
      #bg: "#101010"
      #fg: "#FDF7F7" 
      #primary: "#ED79F9"
      #base_font: !expr bslib::font_google("Prompt")
      #code_font: !expr bslib::font_google("JetBrains Mono")
    orientation: rows
    version: 4
    #source_code: embed
    vertical_layout: scroll
    #social: ["menu"]
    navbar:
      - {icon: "fa-github", 
         title: "Repository", 
         href: "https://github.com/anneval/DA3-phdma/tree/main/A3", align: right, target: blank}
    runtime: shiny
---

<!-- README:  By default dashboards are standard HTML documents that can be deployed on any web server or even attached to an email message. You can optionally add Shiny components for additional interactivity and then deploy on Shiny Server or shinyapps.io. -->

<!-- Task3.1: Use some methods to interpret your random forest probability model (Shapley, PDP) --> 

<!-- Task3.2: Create a shiny (flexdashboard) app for the project where you can show (1) how key variables influence the prediction (!Shapley) and (2) show expected loss based on different thresholds. -->

<!-- replace RF with entire date environment AND
Replace code with graphs "ready"-->

<!-- PLACE ALL GRAPHS INTO A3.rmd!!! just call here to be faster-->

```{r global setup, include=FALSE}
# Clear memory
rm(list=ls())
# set global chunk options
knitr::opts_chunk$set(include = FALSE, fig.align = 'center', cache = TRUE,
                      warning = FALSE, message = FALSE, echo = FALSE)

options(scipen = 999)
```

```{r md setup, include=FALSE}
# Set options for markdown
knitr::opts_knit$set(root.dir = 'C:/Users/avalder/OneDrive - WU Wien/Documents/Study/WS_23_24/Pred_MLE_Econ/da_case_studies')

# store different directories here:
# C:/Users/thuebel/OneDrive - WU Wien/Docs/06 Courses and Study/02 Prediction with ML for Economists/da_case_studies
# C:/Users/avalder/OneDrive - WU Wien/Documents/Study/WS_23_24/Pred_MLE_Econ/da_case_studies
# C:/Users/AnjaHahn/OneDrive - DataScience Service GmbH/WU/Courses/CEU Prediction with Machine Learning for Economists/da_case_studies
```

<!-- Set directory, load functions and theme  --> 
```{r helper functions, include=FALSE}
getwd()
source("set-data-directory.R")
source("ch00-tech-prep/theme_bg.R")
source("ch00-tech-prep/da_helper_functions.R")
```

```{r libraries, include=FALSE}
library(flexdashboard)
library(tsbox)
library(dygraphs)
library(readr)
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
library(readxl)
library(stargazer)
library(vars)
library(ranger)
library(shiny)
library(treeshap)
library(pdp)

```

```{r data,include=FALSE}
data_in <- paste(data_dir,"bisnode-firms", sep = "/")
#load(paste(data_in,"A2.RData",sep = "/")) #activate once we have correct data
rf_old <- read_rds(paste(data_in,"rf_A3.rds",sep = "/")) # save in data dir!!!
```

# <font size="3">Bisnode</font> {data-navmenu="Key variables"}
#### **Importance of key variables**
### {style="border: 0px; background: none"}

TEXT 

## Row {.tabset .tabset-fade}
### Variable importance top 10 


```{r, include=T}
##############################
# 1) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_1
```


### Variable importance grouped 

```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together
rf_model_var_imp_grouped_plot
```

### Variable importance all 

```{r, include=T}
##############################
# 3) full varimp plot, above a cutoff
##############################
rf_model_plots$rf_model_plot_all_1
```

## Row {.tabset .tabset-fade}
### Shapley

```{r,echo=FALSE, include=FALSE, warning=F}
## SHAP VALUES ##
#### all done in code before 
# devtools::install_github('ModelOriented/treeshap')

# #define one-hot encoding function
# dummy <- dummyVars(" ~  ., fullRank=T, sep = NULL)
# 
# #perform one-hot encoding on data frame
# data_holdout_ohe <- data.frame(predict(dummy, newdata=listings_holdout))
# 
# # replace "." character to " " to match model object names
# names(data_holdout_ohe) <- gsub(x = names(data_holdout_ohe),
#                                 pattern = "\\.", 
#                                 replacement = " ")  
# 
# # unify model for treeshap
# rf_model_unified <- ranger.unify(rf_model$finalModel, data_holdout_ohe)
# # when: Error in set_reference_dataset(ret, as.data.frame(data)) : 
# # Dataset does not contain all features occurring in the model.
# 
# #model_variable_names <- rf_model$coefnames
# #new_data_variable_names <- colnames(data_holdout_ohe)
# 
# #missing_variables <- setdiff(rf_model$coefnames, new_data_variable_names)
# #if (length(missing_variables) > 0) {
#  # stop(paste("Error: Missing variables in new data:", toString(missing_variables)))
# #}
# # if Error message (add variables from Error here manually)
# # Identify the indices of the columns you want to change
# indices_to_change <- which(colnames(data_holdout_ohe) %in% c("neighbourhood_cleansedBrnshj Husum", "neighbourhood_cleansedVesterbro Kongens Enghave"))
# 
# # Create a vector of new column names for the selected columns
# new_names <- c("neighbourhood_cleansedBrnshj-Husum", "neighbourhood_cleansedVesterbro-Kongens Enghave")
# 
# # Change the column names only for the selected columns
# names(data_holdout_ohe)[indices_to_change] <- new_names
# 
# ## go back to unify model for treeshap
# 
# #rf_model_unified <- ranger.unify(rf_model$finalModel, data_holdout_ohe)
# 
# #treeshap_res <- treeshap(rf_model_unified, data_holdout_ohe[1:500, ]) # delete # for calculation but excluded here for Rmd knitting 
# 
# #treeshap_res <- plot_contribution(treeshap_res, obs = 12)
# 
# #treeshap_featureIMP <- plot_feature_importance(treeshap_res, max_vars = 10)
# 
# #treeshap_inter <- treeshap(rf_model_unified, data_holdout_ohe[1:100, ], interactions = T)
# #summary(treeshap_res)
```

```{r, figures-Shap, fig.show="hold", out.width="50%", echo =FALSE, warning=FALSE}
#treeshap_res

```

```{r, figures-VARIMP, fig.show="hold", out.width="50%", echo =FALSE, warning=FALSE}

#treeshap_featureIMP
```

## Row {.tabset .tabset-fade}
### Partial dependence plot



```{r,echo=FALSE, include=FALSE, warning=F}
#########################################################################################
# Partial Dependence Plots -------------------------------------------------------
#########################################################################################

#### add loop other predictors but also store each graph so if I change pred different graph some kind of drop down 
```

## Sidebar {.sidebar}

```{r, include=TRUE}
# CHANGE ACCORDING TO OUR DATASET rf_variables
# Assume 'features' is a vector of feature names in your dataset
features <- c("accommodates", "room_type", "other_feature")

selectInput("feature_selector", "Select Feature:", choices = features, selected = features[1])

```


```{r, include=TRUE}
# Assuming rf_old and listings_holdout are defined earlier

### does it work like this or do I need a loop over my features still? (- shiny code together with selectInput above..)In one chunk? 
## add something for displaying?

renderPlot({
  selected_feature <- input$feature_selector
  
  # Check if the selected feature is numeric or categorical
  if (is.numeric(listings_holdout[[selected_feature]])) {
    # Create PDP for numeric feature
    pdp_result <- pdp::partial(rf_old, pred.var = selected_feature, 
                               pred.grid = distinct_(listings_holdout, selected_feature), 
                               train = listings_holdout)
    
    # Customize PDP plot for numeric feature
    pdp_plot <- pdp_result %>%
      autoplot() +
      geom_point(color = color[1], size = 2) +
      geom_line(color = color[1], size = 1) +
      ylab("Predicted price") +
      xlab(paste("Partial Dependence on", selected_feature)) +
      theme_bg()
    
    # Print the plot
    print(pdp_plot)
    
  } else if (is.factor(listings_holdout[[selected_feature]])) {
    # Create PDP for categorical feature
    pdp_result <- pdp::partial(rf_old, pred.var = selected_feature, 
                               pred.grid = unique(listings_holdout[[selected_feature]]), 
                               train = listings_holdout)
    
    # Customize PDP plot for categorical feature
    pdp_plot <- pdp_result %>%
      autoplot() +
      geom_point(color = color[1], size = 2) +
      ylab("Predicted price") +
      xlab(paste("Partial Dependence on", selected_feature)) +
      theme_bg()
    
    # Print the plot
    print(pdp_plot)
  }
})

```


```{r}
# library(dplyr)
# library(pdp)
# library(ggplot2)
# 
# # Assume 'features' is a vector of feature names in your dataset
# features <- c("accommodates", "room_type", "other_feature") 
#  
# for (feature in features) {
#   # Check if the feature is numeric or categorical
#   if (is.numeric(listings_holdout[[feature]])) {
#     # Create PDP for numeric feature
#     pdp_result <- pdp::partial(rf_old, pred.var = feature, 
#                                pred.grid = distinct_(listings_holdout, feature), 
#                                train = listings_holdout)
#     
#     # Customize PDP plot for numeric feature
#     pdp_plot <- pdp_result %>%
#       autoplot() +
#       geom_point(color = color[1], size = 2) +
#       geom_line(color = color[1], size = 1) +
#       ylab("Predicted price") +
#       xlab(paste("Partial Dependence on", feature)) +
#       theme_bg()
#     
#     # Save the plot as an image file (adjust the filename and format as needed)
#     ggsave(paste0("pdp_plot_", feature, ".png"), pdp_plot, width = 6, height = 4)
#     
#   } else if (is.factor(listings_holdout[[feature]])) {
#     # Create PDP for categorical feature
#     pdp_result <- pdp::partial(rf_old, pred.var = feature, 
#                                pred.grid = unique(listings_holdout[[feature]]), 
#                                train = listings_holdout)
#     
#     # Customize PDP plot for categorical feature
#     pdp_plot <- pdp_result %>%
#       autoplot() +
#       geom_point(color = color[1], size = 2) +
#       ylab("Predicted price") +
#       xlab(paste("Partial Dependence on", feature)) +
#       theme_bg()
#     
#     # Save the plot as an image file (adjust the filename and format as needed)
#     ggsave(paste0("pdp_plot_", feature, ".png"), pdp_plot, width = 6, height = 4)
#   }
# }

```


# <font size="3">Manufacturing</font> {data-navmenu="Key variables"}
#### **Importance of key variables**
### {style="border: 0px; background: none"}

TEXT 

## Row {.tabset .tabset-fade}
### Variable importance top 10 

```{r, include=T}
##############################
# 2) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_2
```


### Variable importance grouped 

```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together
```

### Variable importance all 
```{r, include=T}
##############################
# 3) full varimp plot
##############################
rf_model_plots$rf_model_plot_all_2
```

## Row {.tabset .tabset-fade}
### Shapley

```{r}

```


## Row {.tabset .tabset-fade}
### Partial dependence plot


```{r}

```



# <font size="3">Services</font> {data-navmenu="Key variables"}
#### **Importance of key variables**
### {style="border: 0px; background: none"}

TEXT 

## Row {.tabset .tabset-fade}
### Variable importance top 10 
```{r, include=T}
##############################
# 2) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_3
```

### Variable importance grouped
```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together

```

### Variable importance all 
```{r, include=T}
##############################
# 1) full varimp plot
##############################
rf_model_plots$rf_model_plot_all_3
```

## Row {.tabset .tabset-fade}
### Shapley

```{r}

```


## Row {.tabset .tabset-fade}
### Partial dependence plot


```{r}

```




# Threshold decision
#### **Expected loss based on different thresholds:**

TEXT 

```{r}
## add model test RF here 


### call results from other sheet 
# source? 
```



## Row {.tabset .tabset-fade}
### Bisnode
```{r}


#dygraph(economic_sentiment,group = "keywords")%>%
 # dyAxis("x", drawGrid = FALSE)%>%
  #dySeries("value", label = "Index")%>%
 # dyEvent(events$date, events$event, labelLoc = "bottom") %>%
 # dyRangeSelector(dateWindow = c("2006-01-01", today))%>%
 # dyOptions(useDataTimezone = TRUE)
```
### Manufacturing

```{r}

```

### Services

###### Description

The sentiment indicator for the *Perceived Economic Situation* consists of Google search terms that aim to reflect people's concerns about the current economic situation. For instance, people might search for "Wirtschaftskrise" (= economic crisis) to get information.  

###### Keywords

- economic crisis ("Wirtschaftskrise")
- short-term work ("Kurzarbeit)
- unemployed ("arbeitslos")
- insolvency ("Insolvenz")

[Download data](https://raw.githubusercontent.com/anneval/MA_data/main/raw/at/trendecon_sa.csv){target="_blank"}

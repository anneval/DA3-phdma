---
title: "Predicting fast growth"
output: 
  flexdashboard::flex_dashboard:
    theme: journal #  yeti
      #bg: "#101010"
      #fg: "#FDF7F7" 
      #primary: "#ED79F9"
      #base_font: !expr bslib::font_google("Prompt")
      #code_font: !expr bslib::font_google("JetBrains Mono")
    orientation: rows
    version: 4
    #source_code: embed
    vertical_layout: scroll
    #social: ["menu"]
    navbar:
      - {icon: "fa-github", 
         title: "Repository", 
         href: "https://github.com/anneval/DA3-phdma/tree/main/A3", align: right, target: blank}
    runtime: shiny
---



<!-- Task3.1: Use some methods to interpret your random forest probability model (Shapley, PDP) --> 

<!-- Task3.2: Create a shiny (flexdashboard) app for the project where you can show (1) how key variables influence the prediction (!Shapley) and (2) show expected loss based on different thresholds. -->

<!-- replace RF with entire date environment AND
Replace code with graphs "ready"-->

<!-- PLACE ALL GRAPHS INTO A3.rmd!!! just call here to be faster-->

```{r global setup, include=FALSE}
# Clear memory
rm(list=ls())
# set global chunk options
knitr::opts_chunk$set(include = FALSE, fig.align = 'center', cache = F,
                      warning = FALSE, message = FALSE, echo = FALSE)

options(scipen = 999)
```

```{r md setup, include=FALSE}
# Set options for markdown
knitr::opts_knit$set(root.dir = 'C:/Users/avalder/OneDrive - WU Wien/Documents/Study/WS_23_24/Pred_MLE_Econ/da_case_studies')

# store different directories here:
# C:/Users/thuebel/OneDrive - WU Wien/Docs/06 Courses and Study/02 Prediction with ML for Economists/da_case_studies
# C:/Users/avalder/OneDrive - WU Wien/Documents/Study/WS_23_24/Pred_MLE_Econ/da_case_studies
# C:/Users/AnjaHahn/OneDrive - DataScience Service GmbH/WU/Courses/CEU Prediction with Machine Learning for Economists/da_case_studies
```

<!-- Set directory, load functions and theme  --> 
```{r helper functions, include=FALSE}
#getwd()
source("set-data-directory.R")
source("ch00-tech-prep/theme_bg.R")
source("ch00-tech-prep/da_helper_functions.R")
```

```{r libraries, include=FALSE}
library(flexdashboard)
library(tsbox)
library(dygraphs)
library(readr)
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
library(readxl)
library(stargazer)
library(vars)
library(ranger)
library(shiny)
library(treeshap)
library(pdp)
library(pROC)
```

```{r data import,include=FALSE}
data_in <- paste(data_dir,"bisnode-firms", sep = "/")
#load(paste(data_in,"A3.RData",sep = "/")) #activate once we have correct data
load(paste(data_in,"A3_dashboard.RData",sep = "/")) #activate once we have correct data

```
# Variable Importance
#### **Importance of key variables**
### {style="border: 0px; background: none"}
 
## Row {.tabset .tabset-fade}
### Bisnode 
Variable importance all features

```{r, include=T}
##############################
# 3) full varimp plot, above a cutoff
##############################
rf_model_plots$rf_model_plot_all_1
```

###  Manufacturing
Variable importance all features

```{r, include=T}
##############################
# 3) full varimp plot, above a cutoff
##############################
rf_model_plots$rf_model_plot_all_2

```

### Services
Variable importance all features

```{r, include=T}
##############################
# 3) full varimp plot, above a cutoff
##############################
rf_model_plots$rf_model_plot_all_3
```

## Row {.tabset .tabset-fade}
### Bisnode 
Variable importance top 10 
```{r, include=T}
##############################
# 1) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_1

```


###  Manufacturing
Variable importance top 10 
```{r, include=T}
##############################
# 1) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_2
```

### Services
Variable importance top 10 
```{r, include=T}
##############################
# 1) full varimp plot, top 10 only
##############################
rf_model_plots$rf_model_plot_10_3

```


## Row {.tabset .tabset-fade}
### Bisnode 
Variable importance grouped
```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together
rf_model_plots_grouped$rf_model_var_imp_grouped_plot1

```


###  Manufacturing
Variable importance grouped

```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together
rf_model_plots_grouped$rf_model_var_imp_grouped_plot2

```

### Services
Variable importance grouped

```{r, include=T}
##############################
# 2) varimp plot grouped to (8)
##############################
# grouped variable importance - keep binaries created off factors together
rf_model_plots_grouped$rf_model_var_imp_grouped_plot3
```



# <font size="3">Bisnode</font> {data-navmenu="PDP"}
### {style="border: 0px; background: none"}

## Sidebar {.sidebar}

```{r, include=TRUE}
#features <- rfvars# nicer names? 
 features <- c("ceo_age","origin")# nicer names? 
selectInput("feature_selector", "Select Feature form Random forest model:", choices = features, selected = features[1])
```
 
 
```{r PDP1}
# renderPlot({
#   selected_feature <- input$feature_selector
# 
#   # Check if the selected feature is numeric or categorical
#   if (is.numeric(bisnode_holdout[[selected_feature]])) {
# 
#     # Customize PDP plot for numeric feature
#     
#     pdp_plot <- CHANGE %>%
#       autoplot() +
#       geom_point(color = color[1], size = 2) +
#       geom_line(color = color[1], size = 1) +
#       ylab("Growth") +
#       xlab(paste("Partial Dependence on", selected_feature)) +
#       theme_bg()
# 
#     # Print the plot
#     print(pdp_plot)
# 
#   } else if (is.factor(bisnode_holdout[[selected_feature]])) {
# 
#     # Customize PDP plot for categorical feature
#     pdp_plot <- pdp_result %>%
#       autoplot() +
#       geom_point(color = color[1], size = 2) +
#       ylab("Growth") +
#       xlab(paste("Partial Dependence on", selected_feature)) +
#       theme_bg()
# 
#     # Print the plot
#     print(pdp_plot)
#     }#,cacheKeyExpr = {input$feature_selector }
# })

```




```{r, include=TRUE}
output$pdp_plot <- renderPlot({
  selected_feature <- input$feature_selector

  # Check if the selected feature is numeric or categorical
  if (is.numeric(bisnode_holdout[[selected_feature]])) {

    # Retrieve the PDP output for the numeric feature
    pdp_output <- pdp_outputs[[paste0("pdp_", selected_feature)]]

    # Customize PDP plot for numeric feature
    pdp_plot <- pdp_output %>%
      autoplot() +
      geom_point(color = color[1], size = 2) +
      geom_line(color = color[1], size = 1) +
      ylab("Growth") +
      xlab(paste("Partial Dependence on", selected_feature)) +
      theme_bg()

    # Print the plot
    print(pdp_plot)

  } else if (is.factor(bisnode_holdout[[selected_feature]])) {

    # Retrieve the PDP output for the categorical feature
    pdp_output <- pdp_outputs[[paste0("pdp_", selected_feature)]]

    # Customize PDP plot for categorical feature
    pdp_plot <- pdp_output %>%
      autoplot() +
      geom_point(color = color[1], size = 2) +
      ylab("Growth") +
      xlab(paste("Partial Dependence on", selected_feature)) +
      theme_bg()

    # Print the plot
    print(pdp_plot)
  }
})

```



```{r}
# function(input, output) {
#   renderCachedPlot(
#     {
#       rownums <- seq_len(input$n)
#       plot(cars$speed[rownums], cars$dist[rownums])
#     },
#     cacheKeyExpr = { input$n }
#   )
# }

#https://shiny.posit.co/r/articles/improve/plot-caching/
#Usage is simple: in the most basic form, simply replace your renderPlot() with renderCachedPlot(), and add a cache key expression argument. For example, your server function might look like this:
```

# <font size="3">Manufacturing</font> {data-navmenu="PDP"}
### {style="border: 0px; background: none"}

```{r, include=TRUE}
features <- rfvars# nicer names? 
selectInput("feature_selector", "Select Feature form Random forest model:", choices = features, selected = features[1])
```


```{r PDP2, include=TRUE}
```
# <font size="3">Services</font> {data-navmenu="PDP"}
### {style="border: 0px; background: none"}

```{r, include=TRUE}
features <- rfvars# nicer names? 
selectInput("feature_selector", "Select Feature form Random forest model:", choices = features, selected = features[1])

```


```{r PDP3, include=TRUE}

```
# Threshold decision
#### **Expected loss based on different thresholds:**

TEXT 

## Row {.tabset .tabset-fade}
### Bisnode


```{r, include=TRUE}
# re-run losses for RF s.t roc_object is correctly stored
# Now use loss function and search for best thresholds and expected loss over folds -----
rf_model_p_InteractLossPlot
```

### Manufacturing

```{r, include=TRUE}
# re-run losses for RF s.t roc_object is correctly stored
# Now use loss function and search for best thresholds and expected loss over folds -----
rf_model_p_manu_InteractLossPlot
```
### Services
```{r, include=TRUE}
# re-run losses for RF s.t roc_object is correctly stored
# Now use loss function and search for best thresholds and expected loss over folds -----
rf_model_p_serv_InteractLossPlot
```

